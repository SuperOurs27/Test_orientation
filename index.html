<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Strat√©gie Navarre</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f4f4f4; overflow: hidden; }
        #map { height: 50vh; width: 100%; border-bottom: 3px solid #2c3e50; }
        #interface { padding: 10px; text-align: center; height: 50vh; background: white; box-sizing: border-box; position: relative; }
        
        /* Badges */
        #timer-badge { position: absolute; top: 10px; left: 10px; background: #e74c3c; color: white; padding: 8px 15px; border-radius: 20px; z-index: 1000; font-weight: bold; border: 2px solid white; }
        .score-board { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #f1c40f; padding: 8px 15px; border-radius: 20px; z-index: 1000; font-weight: bold; border: 2px solid #f1c40f; }

        /* Tableau des distances */
        .distance-container { display: flex; justify-content: space-around; background: #ecf0f1; border-radius: 10px; padding: 10px; margin: 10px 0; }
        .distance-box { flex: 1; }
        .dist-val { font-size: 1.6em; font-weight: bold; display: block; }
        .dist-label { font-size: 0.8em; color: #7f8c8d; text-transform: uppercase; }
        .color-principale { color: #d35400; }
        .color-bonus { color: #2980b9; }

        .hidden { display: none; }
        input { padding: 12px; width: 80%; font-size: 1em; border-radius: 8px; border: 2px solid #bdc3c7; margin-bottom: 10px; outline: none; }
        button { background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .user-dot { background: #3498db; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="timer-badge">‚è≥ <span id="time-left">60:00</span></div>
    <div class="score-board">üí∞ <span id="score">0</span> pts</div>
    <div id="map"></div>

    <div id="interface">
        <div class="distance-container">
            <div class="distance-box">
                <span class="dist-label">Qu√™te</span>
                <span id="dist-principale" class="dist-val color-principale">-- m</span>
            </div>
            <div style="width: 2px; background: #bdc3c7; margin: 0 10px;"></div>
            <div class="distance-box">
                <span class="dist-label">Tr√©sor</span>
                <span id="dist-bonus" class="dist-val color-bonus">√âteint</span>
            </div>
        </div>

        <h3 id="nom-balise" style="margin: 5px 0; font-size: 1.1em;">Initialisation GPS...</h3>
        
        <div id="zone-enigme" class="hidden">
            <p id="texte-enigme" style="margin: 5px 0; font-style: italic; color: #34495e; font-weight: bold;"></p>
            <input type="text" id="reponse" placeholder="R√©ponse..." autocomplete="off">
            <br>
            <button onclick="validerReponse()">V√âRIFIER</button>
        </div>
        <p id="message-erreur" style="color: #e74c3c; font-weight: bold; margin-top: 10px;"></p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const balises = [
            { id: 1, nom: "Le Ch√™ne d'Id√©fix", lat: 49.01664, lng: 1.11657, enigme: "Combien de menhirs ?", reponse: "3", points: 10 },
            { id: 2, nom: "La hutte du Druide", lat: 49.01754, lng: 1.11535, enigme: "Couleur de la potion ?", reponse: "rouge", points: 20 },
            { id: 3, nom: "Le camp Romain", lat: 49.01650, lng: 1.11351, enigme: "Qui est le chef ?", reponse: "cesar", points: 50 }
        ];

        let tempsRestant = 60 * 60; 
        let indexEtape = 0;
        let score = 0;
        let map, markerCible, markerJoueur, markerBonus;
        
        // Nouvelle gestion du bonus (avec un verrou "captured")
        let bonusActif = { lat: 0, lng: 0, visible: false, captured: false };

        map = L.map('map', { zoomControl: false }).setView([balises[0].lat, balises[0].lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- D√âFINITION DES COULEURS ---
        const iconeRouge = L.divIcon({ html: '<div style="background:#e74c3c; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>', className: '' });
        const iconeJaune = L.divIcon({ html: '<div style="background:#f1c40f; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow: 0 0 10px #f1c40f;"></div>', className: '' });
        const iconeVerte = L.divIcon({ html: '<div style="background:#2ecc71; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow: 0 0 10px #2ecc71;"></div>', className: '' });
        const iconeOr = L.divIcon({ html: '<div style="background:gold; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px gold;"></div>', className: '' });

        // Initialisation des marqueurs
        markerCible = L.marker([balises[indexEtape].lat, balises[indexEtape].lng], {icon: iconeRouge}).addTo(map);
        markerBonus = L.marker([0, 0], {icon: iconeOr, opacity: 0}).addTo(map);

        // --- HORLOGE ET APPARITION BONUS ---
        setInterval(() => {
            if (tempsRestant <= 0) return terminerJeu("FIN DU TEMPS");
            tempsRestant--;
            let min = Math.floor(tempsRestant / 60);
            let sec = tempsRestant % 60;
            document.getElementById('time-left').innerText = min + ":" + (sec < 10 ? '0' : '') + sec;
            
            if (tempsRestant % 600 === 0) genererBonus();
        }, 1000);

        // --- G√âN√âRATION DU BONUS DANS UN RAYON DE 500M ---
        function genererBonus() {
            if (!markerJoueur) {
                // Si le GPS n'a pas encore trouv√© le joueur, on r√©essaye dans 2 secondes
                setTimeout(genererBonus, 2000);
                return;
            }
            
            let posJoueur = markerJoueur.getLatLng();
            let rayonMax = 500; // 500 m√®tres
            
            // Calcul math√©matique pour un point al√©atoire autour du joueur
            let r = Math.sqrt(Math.random()) * rayonMax; 
            let theta = Math.random() * 2 * Math.PI;
            
            // Conversion des m√®tres en coordonn√©es GPS
            let dLat = r * Math.cos(theta) / 111320;
            let dLng = r * Math.sin(theta) / (111320 * Math.cos(posJoueur.lat * Math.PI / 180));
            
            bonusActif.lat = posJoueur.lat + dLat;
            bonusActif.lng = posJoueur.lng + dLng;
            bonusActif.visible = true;
            bonusActif.captured = false; // R√©initialise le verrou
            
            markerBonus.setLatLng([bonusActif.lat, bonusActif.lng]);
            markerBonus.setIcon(iconeOr);
            markerBonus.setOpacity(1);
        }

        // --- GESTION DU GPS ---
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                let uLat = pos.coords.latitude;
                let uLng = pos.coords.longitude;

                // Mise √† jour de la position du joueur
                if (!markerJoueur) {
                    markerJoueur = L.marker([uLat, uLng], {icon: L.divIcon({className: 'user-dot'})}).addTo(map);
                    map.panTo([uLat, uLng]);
                } else {
                    markerJoueur.setLatLng([uLat, uLng]);
                }

                // --- 1. GESTION DE LA QU√äTE PRINCIPALE ---
                let cible = balises[indexEtape];
                if (cible) {
                    let d = calculerDistance(uLat, uLng, cible.lat, cible.lng);
                    document.getElementById('dist-principale').innerText = Math.round(d) + " m";
                    
                    if (d <= 25) {
                        markerCible.setIcon(iconeJaune); // Passe en jaune car on est proche
                        document.getElementById('zone-enigme').classList.remove('hidden');
                        document.getElementById('nom-balise').innerText = "üéØ " + cible.nom;
                        document.getElementById('texte-enigme').innerText = cible.enigme;
                    } else {
                        markerCible.setIcon(iconeRouge); // Repasse au rouge si on s'√©loigne
                        document.getElementById('zone-enigme').classList.add('hidden');
                        document.getElementById('nom-balise').innerText = "Vers : " + cible.nom;
                    }
                }

                // --- 2. GESTION DU TR√âSOR (BONUS) ---
                if (bonusActif.visible) {
                    let dB = calculerDistance(uLat, uLng, bonusActif.lat, bonusActif.lng);
                    document.getElementById('dist-bonus').innerText = Math.round(dB) + " m";
                    
                    // Si on touche le bonus et qu'il n'a pas encore √©t√© captur√©
                    if (dB <= 25 && !bonusActif.captured) {
                        bonusActif.captured = true; // Verrouille pour √©viter les doublons
                        
                        // Ajout des points
                        score += 50;
                        document.getElementById('score').innerText = score;
                        document.getElementById('dist-bonus').innerText = "PRIS !";
                        
                        // Le marqueur passe au vert
                        markerBonus.setIcon(iconeVerte);
                        
                        // Dispara√Æt apr√®s 5 secondes
                        setTimeout(() => {
                            bonusActif.visible = false;
                            markerBonus.setOpacity(0);
                            document.getElementById('dist-bonus').innerText = "---";
                        }, 5000);
                    }
                } else {
                    document.getElementById('dist-bonus').innerText = "---";
                }
            }, null, { enableHighAccuracy: true });
        }

        // --- VALIDATION DES R√âPONSES ---
        function validerReponse() {
            let champ = document.getElementById('reponse');
            let r = champ.value.trim().toLowerCase();
            let cible = balises[indexEtape];
            
            if (r === cible.reponse.toLowerCase()) {
                // Ajout des points
                score += cible.points;
                document.getElementById('score').innerText = score;
                document.getElementById('zone-enigme').classList.add('hidden');
                champ.value = "";
                
                // On laisse un marqueur VERT d√©finitif sur la carte √† l'endroit valid√©
                L.marker([cible.lat, cible.lng], {icon: iconeVerte}).addTo(map);
                
                indexEtape++;
                
                if (indexEtape < balises.length) {
                    // On d√©place le point cible et on le remet en ROUGE
                    markerCible.setLatLng([balises[indexEtape].lat, balises[indexEtape].lng]);
                    markerCible.setIcon(iconeRouge);
                    alert("Bravo ! +" + cible.points + " pts. Direction la suite !");
                } else {
                    terminerJeu("VICTOIRE !");
                }
            } else {
                document.getElementById('message-erreur').innerText = "‚ùå Faux ! Cherche bien...";
                setTimeout(() => { document.getElementById('message-erreur').innerText = ""; }, 2000);
            }
        }

        function terminerJeu(t) {
            document.getElementById('interface').innerHTML = `<h2 style="color:#27ae60">${t}</h2><h3 style="font-size:1.5em;">Score Final : ${score} pts</h3><button onclick="location.reload()">REJOUER</button>`;
            tempsRestant = 0;
            if(markerCible) map.removeLayer(markerCible);
        }

        function calculerDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3;
            var dLat = (lat2-lat1) * Math.PI/180;
            var dLon = (lon2-lon1) * Math.PI/180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // G√©n√®re un premier bonus apr√®s 5 secondes pour tester le code
        setTimeout(genererBonus, 5000);
    </script>
</body>
</html>

